import openpyxl
from openpyxl.styles import PatternFill, Alignment, Font, Border, Side
from openpyxl import load_workbook
from datetime import datetime
from tkinter import *
from tkinter import filedialog
import os
root=Tk()
root.withdraw()
source_workbook_path = filedialog.askopenfilename(title="select a reference file",filetypes=(("excel files","*.xlsx"),("all files","*.*")))
source_wb = load_workbook(source_workbook_path, data_only=True)
current_date = datetime.now()
currentyear = current_date.strftime('%Y')
wb = openpyxl.Workbook()
default_font = Font(name='Calibri')
new_sheet = wb.create_sheet(title=f"Emp_leave {currentyear}")
def formatsheet(currentsheet):
  for row in range(3, 58):
    for col in range(2, 4):
      new_sheet.cell(row=row, column=col, value=currentsheet.cell(row=row, column=col).value)
col1=4
col2=5

for sheet_name in source_wb.sheetnames:
    if '24' in sheet_name:
        currentsheet = source_wb[sheet_name]
        formatsheet(currentsheet)
        new_sheet.cell(row=2, column=col1, value=f"{sheet_name}")
        new_sheet.merge_cells(start_row=2, start_column=col1, end_row=2, end_column=col2)
        new_sheet.cell(row=3, column=col1, value="Leave")
        new_sheet.cell(row=3, column=col2, value="Sick")

        for row in range(4, 58):
            new_sheet.cell(row=row, column=col1, value=currentsheet.cell(row=row, column=4).value)
            new_sheet.cell(row=row, column=col2, value=currentsheet.cell(row=row, column=6).value)
        
        col1 += 2
        col2 += 2

new_sheet.cell(row=3, column=col1, value="Total leave")
new_sheet.merge_cells(start_row=row, start_column=col1, end_row=row, end_column=col2)
for row in range(4, 58):
    totalsum=0
    for col in range(4,col1):
        cell_value = new_sheet.cell(row=row, column=col).value
        if isinstance(cell_value, (int, float)):  
            totalsum += cell_value    
    new_sheet.cell(row=row, column=col1, value=totalsum)
    new_sheet.merge_cells(start_row=row, start_column=col1, end_row=row, end_column=col2)
    
default_sheet = wb["Sheet"]
wb.remove(default_sheet)
directory=os.path.dirname(source_workbook_path)
file_name_with_extension = os.path.basename(source_workbook_path)
file_name_without_extension = os.path.splitext(file_name_with_extension)[0]
newfilename="LEAVE REPORT.xlsx"
new_file_path = os.path.join(directory, newfilename)
wb.save(f"{new_file_path}")
